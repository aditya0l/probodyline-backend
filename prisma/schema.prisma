// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Phase 1 Models
// Organization is a singleton - stores company information for Probodyline Fitness
model Organization {
  id                 String   @id @default(uuid())
  name               String
  address            String
  gst                String
  phone              String
  email              String
  website            String
  contactPerson      String
  logo               String? // URL/path
  bankDetails        String?  @db.Text
  termsAndConditions String?  @db.Text
  warrantyInfo       String?  @db.Text
  defaultGstRate     Decimal  @default(18) @db.Decimal(5, 2)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations (optional - for users only)
  users User[]

  @@map("organizations")
}

model Category {
  id          String    @id @default(uuid())
  name        String
  parentId    String?
  description String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // Relations
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@unique([name])
  @@map("categories")
}

// Phase 2 Models
model Product {
  id                   String    @id @default(uuid())
  srNo                 Int // Auto-increment globally
  priority             Int       @default(1)
  name                 String
  modelNumber          String?
  image                String? // URL/path
  images               String[] // Array of URLs (max 5)
  price                Decimal?  @db.Decimal(12, 2)
  productType          String? // Can be FK to Category later
  categoryId           String?
  seriesName           String?
  packagingDescription String[] // JSON array
  keyword              String[] // JSON array
  todaysStock          Int?      @default(0)
  stockPlus360Days     Int?      @default(0)
  dateSelectStock      DateTime?
  stockByDate          Json? // Key-value: date -> stock
  mrpStickers          String[] // JSON array of URLs
  customDeclarations   String[] // JSON array of URLs
  cartonLabel          String? // URL
  machineArtwork       String? // URL
  brochure             String[] // JSON array of URLs
  thumbnail            String? // URL
  cousinMachine        String? // Could be FK to Product
  orderTogether        String? // Could be FK to Product
  swapMachine          String? // Could be FK to Product
  brand                String?
  warranty             String?
  notes                String?   @db.Text
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deletedAt            DateTime?

  // Relations
  category          Category?          @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  quotationItems    QuotationItem[]
  stockTransactions StockTransaction[]
  bookings          Booking[]          @relation("ProductBookings")

  @@index([name])
  @@index([modelNumber])
  @@index([seriesName])
  @@index([productType])
  @@index([deletedAt])
  @@index([categoryId])
  @@map("products")
}

model Customer {
  id            String    @id @default(uuid())
  name          String
  gymName       String?
  address       String?
  city          String?
  area          String?
  gst           String?
  phone         String?
  email         String?
  contactPerson String?
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  // Relations
  quotations Quotation[]

  @@index([name])
  @@map("customers")
}

enum QuotationStatus {
  CREATED
  CONVERTED
  DRAFT
  CONFIRMED
}

model Quotation {
  id              String          @id @default(uuid())
  quoteNumber     String          @unique // Format: Q-YYYYMMDD-XXX
  quotationNumber String? // Alias for quoteNumber
  status          QuotationStatus @default(DRAFT) // enum: CREATED, CONVERTED, DRAFT, CONFIRMED
  customerId      String?
  clientId        String? // FK to Client
  gymId           String? // FK to Gym
  leadId          String? // FK to Lead

  // Company info (denormalized for historical accuracy)
  companyName          String
  companyAddress       String
  companyLogo          String?
  companyGST           String
  companyPhone         String
  companyEmail         String
  companyWebsite       String
  companyContactPerson String

  // Client info (denormalized for PDF generation)
  clientName       String?
  clientAddress    String?
  clientCity       String?
  gymName          String?
  gymArea          String?
  clientGST        String?
  deliveryDate     DateTime?
  dispatchDate     DateTime? // yyyy-mm-dd format
  installationDate DateTime? // yyyy-mm-dd format
  inaugurationDate DateTime? // yyyy-mm-dd format
  quoteDate        String? // yyyy-mm-dd/hh:mm format
  bookingDate      String? // yyyy-mm-dd/hh:mm format
  leadName         String?

  // Financial
  subtotal   Decimal @db.Decimal(12, 2)
  gstRate    Decimal @default(18) @db.Decimal(5, 2)
  gstAmount  Decimal @db.Decimal(12, 2)
  grandTotal Decimal @db.Decimal(12, 2)

  // Additional
  bankDetails        String? @db.Text
  termsAndConditions String? @db.Text
  warrantyInfo       String? @db.Text
  pdfUrl             String? // URL to generated PDF

  // Metadata
  visibleColumns Json? // Column visibility settings
  template       String    @default("default") // enum: default, wholesale, retail, loading, price-list
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  // Relations
  customer Customer?       @relation(fields: [customerId], references: [id], onDelete: SetNull)
  client   Client?         @relation("ClientQuotations", fields: [clientId], references: [id], onDelete: SetNull)
  gym      Gym?            @relation("GymQuotations", fields: [gymId], references: [id], onDelete: SetNull)
  lead     Lead?           @relation("LeadQuotations", fields: [leadId], references: [id], onDelete: SetNull)
  items    QuotationItem[]
  bookings Booking[]       @relation("QuotationBookings")

  @@index([status])
  @@index([createdAt])
  @@index([quoteNumber])
  @@index([status, createdAt])
  @@index([clientId])
  @@index([gymId])
  @@index([leadId])
  @@map("quotations")
}

model QuotationItem {
  id                   String    @id @default(uuid())
  quotationId          String
  srNo                 Int
  productId            String?
  expectedDispatchDate DateTime? // For booking allocation

  // Denormalized product data (for historical accuracy)
  productName  String
  productImage String?
  modelNumber  String?
  rate         Decimal @db.Decimal(12, 2)
  quantity     Int
  totalAmount  Decimal @db.Decimal(12, 2)

  // All product fields (denormalized)
  priority             Int?
  productType          String?
  seriesName           String?
  packagingDescription String[] // JSON array
  keyword              String[] // JSON array
  todaysStock          Int?
  stockPlus360Days     Int?
  cousinMachine        String?
  orderTogether        String?
  swapMachine          String?
  category             String?
  brand                String?
  warranty             String?
  notes                String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  product   Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  bookings  Booking[] @relation("QuotationItemBookings")

  @@index([quotationId])
  @@index([productId])
  @@map("quotation_items")
}

// Phase 3 Models
model Vendor {
  id            String    @id @default(uuid())
  name          String
  address       String?
  contactPerson String?
  phone         String?
  email         String?
  gst           String?
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  @@map("vendors")
}

enum StockTransactionType {
  IN
  OUT
  ADJUSTMENT
  SALE
  PURCHASE
  PI_BOOKING
}

model StockTransaction {
  id              String               @id @default(uuid())
  productId       String
  transactionType StockTransactionType
  quantity        Int // Positive for in, negative for out
  referenceType   String? // e.g., 'quotation', 'purchase_order', 'PI_BOOKING'
  referenceId     String? // UUID of reference
  factoryId       String? // Factory identifier for multi-factory support
  date            DateTime
  notes           String?              @db.Text
  createdAt       DateTime             @default(now())
  createdBy       String? // FK to User (future)

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, date])
  @@index([date])
  @@index([referenceType, referenceId])
  @@map("stock_transactions")
}

// ============================================================================
// CLIENT DIRECTORY MODULE
// ============================================================================

model Client {
  id           String    @id @default(uuid())
  clientCode   String    @unique // Auto-generated, immutable: TOKEN_DATE/STATE/CITY/CLIENT_NAME/SALES_INITIAL
  tokenDate    DateTime // YYYY-MM-DD, immutable (business token/contract date)
  stateCode    String
  city         String
  clientName   String
  salesPerson  String // Full name
  salesInitial String // Code identifier (mandatory)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  // Relations
  clientGyms     ClientGym[]
  clientLeads    ClientLead[]
  clientPartners ClientPartner[]
  quotations     Quotation[]     @relation("ClientQuotations") // Quotations linked to this client
  gymClients     GymClient[]

  @@index([clientCode])
  @@index([stateCode])
  @@index([city])
  @@index([salesPerson])
  @@index([deletedAt])
  @@map("clients")
}

model ClientGym {
  id       String   @id @default(uuid())
  clientId String
  gymId    String
  linkedOn DateTime @default(now())

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  gym    Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@unique([clientId, gymId])
  @@index([clientId])
  @@index([gymId])
  @@map("client_gyms")
}

model ClientLead {
  id       String   @id @default(uuid())
  clientId String
  leadId   String
  linkedOn DateTime @default(now())

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([clientId, leadId])
  @@index([clientId])
  @@index([leadId])
  @@map("client_leads")
}

model ClientPartner {
  id           String   @id @default(uuid())
  clientId     String
  partnerType  String // 'CLIENT' | 'LEAD'
  partnerRefId String // Reference to client ID or lead ID
  linkedOn     DateTime @default(now())

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, partnerType, partnerRefId])
  @@index([clientId])
  @@map("client_partners")
}

// ============================================================================
// GYM DIRECTORY MODULE
// ============================================================================

model Gym {
  id               String    @id @default(uuid())
  gymCode          String    @unique // Auto-generated, immutable: INSTALLATION_DATE/STATE/CITY/GYM_NAME/BRANCH_CODE/BRANCH_TITLE/SALES_INITIAL
  installationDate DateTime // YYYY-MM-DD, editable, history tracked via AuditLog
  stateCode        String
  city             String
  gymName          String
  branchCode       Decimal   @db.Decimal(3, 1) // 1.0 â†’ 99.0
  branchTitle      String
  salesInitial     String // Mandatory
  instagramLink    String?
  locationLink     String?
  locationQR       String? // Auto-generated from locationLink
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?

  // Relations
  inaugurationHistory InaugurationCommitment[]
  clientGyms          ClientGym[] // Opposite relation for ClientGym.gym
  gymClients          GymClient[]
  gymTechnicians      GymTechnician[]
  gymMedia            GymMedia[]
  quotations          Quotation[]              @relation("GymQuotations") // Quotations linked to this gym

  @@index([gymCode])
  @@index([stateCode])
  @@index([city])
  @@index([deletedAt])
  @@map("gyms")
}

model InaugurationCommitment {
  id           String   @id @default(uuid())
  gymId        String
  committedOn  DateTime @default(now()) // System date when commitment was made
  committedFor DateTime // Planned inauguration date (YYYY-MM-DD)
  source       String // 'SYSTEM' | 'USER'
  note         String?  @db.Text
  createdBy    String? // FK to User (future)
  createdAt    DateTime @default(now())

  // Relations
  gym Gym @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@index([gymId, committedFor])
  @@index([committedFor])
  @@map("inauguration_commitments")
}

model GymClient {
  id            String   @id @default(uuid())
  gymId         String
  clientId      String
  linkedOn      DateTime @default(now())
  referenceCode String // YYYY-MM-DD/STATE/CITY/CLIENT_NAME/SALES_INITIAL

  // Relations
  gym    Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([gymId, clientId])
  @@index([gymId])
  @@index([clientId])
  @@map("gym_clients")
}

model GymTechnician {
  id           String   @id @default(uuid())
  gymId        String
  technicianId String // FK to User/Technician entity (future)
  linkedOn     DateTime @default(now())

  // Relations
  gym Gym @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@unique([gymId, technicianId])
  @@index([gymId])
  @@map("gym_technicians")
}

model GymMedia {
  id         String   @id @default(uuid())
  gymId      String
  mediaType  String // 'IMAGE' | 'VIDEO'
  url        String
  uploadedBy String? // FK to User (future)
  uploadedAt DateTime @default(now())

  // Relations
  gym Gym @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@index([gymId])
  @@index([uploadedAt])
  @@map("gym_media")
}

// ============================================================================
// LEAD DIRECTORY MODULE
// ============================================================================

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL_SENT
  NEGOTIATION
  WON
  LOST
  CONVERTED
}

model Lead {
  id         String     @id @default(uuid())
  leadNumber String     @unique // Auto-generated
  name       String
  company    String?
  email      String?
  phone      String?
  address    String?
  city       String?
  stateCode  String?
  source     String? // Lead source
  status     LeadStatus @default(NEW)
  notes      String?    @db.Text
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  deletedAt  DateTime?

  // Relations
  statusHistory LeadStatusHistory[]
  clientLeads   ClientLead[]
  quotations    Quotation[]         @relation("LeadQuotations") // Quotations linked to this lead

  @@index([status])
  @@index([source])
  @@index([deletedAt])
  @@map("leads")
}

model LeadStatusHistory {
  id        String     @id @default(uuid())
  leadId    String
  status    LeadStatus
  changedAt DateTime   @default(now())
  changedBy String? // FK to User (future)
  notes     String?    @db.Text

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId, changedAt])
  @@map("lead_status_history")
}

// ============================================================================
// BOOKING & ALLOCATION MODULE
// ============================================================================

enum BookingStatus {
  CONFIRM
  WAITING_LIST
}

model Booking {
  id               String        @id @default(uuid())
  quotationId      String // FK to Quotation (PI)
  quotationItemId  String // FK to QuotationItem
  productId        String
  quoteNumber      String
  dispatchDate     DateTime // YYYY-MM-DD
  bookedOn         DateTime // Timestamp for priority (first booked = first served)
  customerName     String?
  gymName          String?
  stateCode        String?
  city             String?
  requiredQuantity Int
  status           BookingStatus
  waitingQuantity  Int           @default(0) // Only if WAITING_LIST
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  product       Product       @relation("ProductBookings", fields: [productId], references: [id], onDelete: Cascade)
  quotation     Quotation     @relation("QuotationBookings", fields: [quotationId], references: [id], onDelete: Cascade)
  quotationItem QuotationItem @relation("QuotationItemBookings", fields: [quotationItemId], references: [id], onDelete: Cascade)

  @@index([productId, dispatchDate])
  @@index([dispatchDate])
  @@index([bookedOn])
  @@index([status])
  @@index([quotationId])
  @@map("bookings")
}

// ============================================================================
// AUDIT & HISTORY MODULE
// ============================================================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  LINK
  UNLINK
}

model AuditLog {
  id          String      @id @default(uuid())
  entityType  String // 'Client', 'Gym', 'Quotation', 'Booking', etc.
  entityId    String
  action      AuditAction
  fieldName   String? // Field that was changed (for UPDATE)
  oldValue    String?     @db.Text // Old value (JSON stringified if object)
  newValue    String?     @db.Text // New value (JSON stringified if object)
  performedBy String? // FK to User (future)
  performedAt DateTime    @default(now())
  notes       String?     @db.Text

  @@index([entityType, entityId])
  @@index([performedAt])
  @@index([action])
  @@map("audit_logs")
}

// Authentication Models
enum UserRole {
  ADMIN
  MANAGER
  USER
}

model User {
  id             String    @id @default(uuid())
  organizationId String? // Optional - for future flexibility
  email          String    @unique
  password       String // Hashed password
  name           String
  role           UserRole  @default(USER)
  isActive       Boolean   @default(true)
  lastLoginAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([organizationId])
  @@map("users")
}
